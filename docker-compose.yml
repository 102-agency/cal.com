# Cal.com deployment optimized for Coolify
# Documentation: https://cal.com/docs/self-hosting/docker

volumes:
  database-data:
  redis-data:

networks:
  stack:
    name: stack
    external: false

services:
  database:
    container_name: database
    image: postgres:16-alpine
    restart: always
    volumes:
      - database-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER:?}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?}
      - POSTGRES_DB=${POSTGRES_DB:-calendso}
    networks:
      - stack
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 20s
      retries: 10

  redis:
    container_name: redis
    image: redis:7-alpine
    restart: always
    volumes:
      - redis-data:/data
    networks:
      - stack
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  calcom:
    container_name: calcom
    image: calcom/cal.com:latest
    restart: always
    networks:
      - stack
    environment:
      # Coolify Magic Variables for URL generation
      - SERVICE_FQDN_CALCOM_3000
      
      # Database (using service name for internal DNS)
      - DATABASE_URL=postgresql://${POSTGRES_USER:?}:${POSTGRES_PASSWORD:?}@database:5432/${POSTGRES_DB:-calendso}
      - DATABASE_DIRECT_URL=postgresql://${POSTGRES_USER:?}:${POSTGRES_PASSWORD:?}@database:5432/${POSTGRES_DB:-calendso}
      
      # Redis (using service name for internal DNS)
      - REDIS_URL=redis://redis:6379
      
      # Core Config - Uses Coolify generated FQDN
      - NODE_ENV=production
      - NEXT_PUBLIC_WEBAPP_URL=${SERVICE_FQDN_CALCOM_3000}
      - NEXT_PUBLIC_API_V2_URL=${SERVICE_FQDN_CALCOM_3000}/api/v2
      - NEXTAUTH_URL=${SERVICE_FQDN_CALCOM_3000}/api/auth
      
      # Secrets - Coolify auto-generated passwords
      - NEXTAUTH_SECRET=${SERVICE_PASSWORD_64_NEXTAUTH:?}
      - CALENDSO_ENCRYPTION_KEY=${SERVICE_BASE64_64_CALENDSO:?}
      - JWT_SECRET=${SERVICE_PASSWORD_64_JWT:?}
      - CRON_API_KEY=${SERVICE_PASSWORD_CRON}
      
      # License & Telemetry
      - NEXT_PUBLIC_LICENSE_CONSENT=${NEXT_PUBLIC_LICENSE_CONSENT:-agree}
      - CALCOM_TELEMETRY_DISABLED=${CALCOM_TELEMETRY_DISABLED:-1}
      - CALCOM_LICENSE_KEY=${CALCOM_LICENSE_KEY}
      
      # Email Configuration
      - EMAIL_FROM=${EMAIL_FROM:?}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Cal.com}
      - EMAIL_SERVER_HOST=${EMAIL_SERVER_HOST:?}
      - EMAIL_SERVER_PORT=${EMAIL_SERVER_PORT:-587}
      - EMAIL_SERVER_USER=${EMAIL_SERVER_USER}
      - EMAIL_SERVER_PASSWORD=${EMAIL_SERVER_PASSWORD}
      
      # App Settings
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Cal.com}
      - CSP_POLICY=${CSP_POLICY}
      - NEXT_PUBLIC_DISABLE_SIGNUP=${NEXT_PUBLIC_DISABLE_SIGNUP}
      
      # Organizations
      - ORGANIZATIONS_ENABLED=${ORGANIZATIONS_ENABLED}
      - NEXT_PUBLIC_SINGLE_ORG_SLUG=${NEXT_PUBLIC_SINGLE_ORG_SLUG}
      - ORGANIZATIONS_AUTOLINK=${ORGANIZATIONS_AUTOLINK}
      
      # Stripe (Optional)
      - STRIPE_API_KEY=${STRIPE_API_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - STRIPE_CLIENT_ID=${STRIPE_CLIENT_ID}
      - STRIPE_PRIVATE_KEY=${STRIPE_PRIVATE_KEY}
      - NEXT_PUBLIC_STRIPE_PREMIUM_PLAN_PRICE=${NEXT_PUBLIC_STRIPE_PREMIUM_PLAN_PRICE}
      
      # Feature Flags
      - IS_E2E=${IS_E2E:-false}
      - IS_TEAM_BILLING_ENABLED=${IS_TEAM_BILLING_ENABLED:-false}
      - REWRITE_API_V2_PREFIX=${REWRITE_API_V2_PREFIX:-true}
      - CRON_ENABLE_APP_SYNC=${CRON_ENABLE_APP_SYNC:-false}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOGGER_BRIDGE_LOG_LEVEL=${LOGGER_BRIDGE_LOG_LEVEL}
      
      # Google API (Optional)
      - GOOGLE_API_CREDENTIALS=${GOOGLE_API_CREDENTIALS}
      - GOOGLE_LOGIN_ENABLED=${GOOGLE_LOGIN_ENABLED:-false}
      
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy

  calcom-api:
    container_name: calcom-api
    image: calcom/cal.com:latest
    restart: always
    networks:
      - stack
    environment:
      # Coolify Magic Variables for API
      - SERVICE_FQDN_CALCOM-API_5555
      
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:?}:${POSTGRES_PASSWORD:?}@database:5432/${POSTGRES_DB:-calendso}
      - DATABASE_READ_URL=postgresql://${POSTGRES_USER:?}:${POSTGRES_PASSWORD:?}@database:5432/${POSTGRES_DB:-calendso}
      - DATABASE_WRITE_URL=postgresql://${POSTGRES_USER:?}:${POSTGRES_PASSWORD:?}@database:5432/${POSTGRES_DB:-calendso}
      - DATABASE_DIRECT_URL=postgresql://${POSTGRES_USER:?}:${POSTGRES_PASSWORD:?}@database:5432/${POSTGRES_DB:-calendso}
      
      # Redis
      - REDIS_URL=redis://redis:6379
      
      # Core Config
      - NODE_ENV=production
      - API_PORT=5555
      - API_URL=${SERVICE_FQDN_CALCOM-API_5555}
      - WEB_APP_URL=${SERVICE_FQDN_CALCOM_3000}
      
      # Auth - Reuse same secrets from main app
      - NEXTAUTH_SECRET=${SERVICE_PASSWORD_64_NEXTAUTH:?}
      - JWT_SECRET=${SERVICE_PASSWORD_64_JWT:?}
      - API_KEY_PREFIX=${API_KEY_PREFIX:-cal_}
      
      # License
      - CALCOM_LICENSE_KEY=${CALCOM_LICENSE_KEY}
      
      # Feature Flags
      - IS_E2E=${IS_E2E:-false}
      - REWRITE_API_V2_PREFIX=${REWRITE_API_V2_PREFIX:-true}
      - IS_TEAM_BILLING_ENABLED=${IS_TEAM_BILLING_ENABLED:-false}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOGGER_BRIDGE_LOG_LEVEL=${LOGGER_BRIDGE_LOG_LEVEL}
      
      # Stripe (Optional)
      - STRIPE_API_KEY=${STRIPE_API_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      
    command: yarn workspace @calcom/api-v2 start:prod
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
